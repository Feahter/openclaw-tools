---
name: context-manager
description: 上下文管理器 - 智能压缩、摘要和管理对话历史，优化长对话的token使用。用于长对话维护、信息提取、记忆管理。适用场景：长任务跟踪、多轮对话优化、历史会话检索。
---

# Context Manager (上下文管理器)

智能管理对话上下文，在保持关键信息的同时优化token使用。

## 核心功能

### 1. 对话摘要
将长对话压缩为关键信息摘要。

**输入**: 20轮对话历史
**输出**: 结构化摘要
```yaml
summary:
  topic: "搭建个人博客系统"
  decisions:
    - "使用Next.js作为框架"
    - "部署到Vercel"
  action_items:
    - "配置DNS"
    - "购买域名"
  context: "用户是前端新手，需要详细指导"
  pending_questions: 
    - "是否需要CMS？"
```

### 2. 滑动窗口管理
保留最近N轮完整对话，早期对话转为摘要。

```
[完整对话] x 10轮
[摘要] 早期对话
[系统指令]
```

### 3. 关键信息提取
从对话中提取重要信息写入MEMORY.md。

**自动触发条件**:
- 用户明确说"记住..."
- 做了重要决策
- 识别出偏好设置

### 4. 历史会话检索
跨会话检索相关历史对话。

```
"我之前好像问过类似的问题"
→ context-manager检索历史会话
→ 返回相关对话片段
```

## 使用方法

### 显式调用
```
总结一下我们刚才讨论的内容
```
```
把我们这次的讨论要点记录下来
```
```
检索我之前关于MCP的讨论
```

### 自动触发
当对话超过配置的长度阈值时，自动进行摘要。

## 策略配置

### 压缩策略
```yaml
compression:
  strategy: "selective"  # selective | aggressive | conservative
  keep_recent: 10        # 保留最近N轮完整对话
  summarize_threshold: 20  # 超过N轮开始摘要
```

### 摘要粒度
- **High**: 每句话都重要，完整保留
- **Medium**: 保留关键决策和行动项
- **Low**: 只保留主题和结论

### 记忆写入
```yaml
memory_extraction:
  auto_extract: true
  triggers:
    - "用户说'记住'"
    - "重要决策"
    - "偏好设置"
```

## 输出格式

### 对话摘要
```markdown
## 对话摘要

**主题**: 搭建个人博客系统

**关键决策**:
1. 使用Next.js作为框架（2024-02-07 15:30）
2. 部署到Vercel免费版（2024-02-07 15:35）

**待办事项**:
- [ ] 配置DNS解析
- [ ] 购买域名

**重要上下文**:
- 用户是前端新手，需要详细指导
- 预算有限，偏好免费方案

**待解决问题**:
- 是否需要集成CMS？
```

### 历史检索结果
```json
{
  "query": "MCP 配置",
  "matches": [
    {
      "session": "2024-02-01",
      "relevance": 0.88,
      "snippet": "讨论了MCP的stdio和http两种传输方式...",
      "key_points": ["stdio适合本地", "http适合远程"]
    }
  ]
}
```

## 与memory系统集成

### 写入MEMORY.md
```markdown
# MEMORY.md

## 技术偏好 (2024-02-07)
- 前端框架: Next.js
- 部署平台: Vercel
- 预算: 优先免费方案
```

### 读取记忆
在启动新会话时，自动加载相关记忆作为上下文。

## 实现依赖

- 摘要模型（轻量级，用于压缩对话）
- 向量检索（用于历史会话检索）
- MEMORY.md读写能力

## 运行规则

1. 监控对话长度和token使用
2. 超过阈值时触发摘要
3. 提取关键信息写入记忆
4. 用户查询历史时执行检索
5. 保持上下文连贯性
